<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (pozostała część head taka sama) ... -->
</head>
<body>
    <!-- ... (pozostała część HTML taka sama) ... -->

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
    <script>
        let web3;
        let contract;
        let account;
        
        // Konfiguracja - zmień te wartości!
        const CONTRACT_ADDRESS = "0xYourContractAddress"; 
        const INFURA_ID = "YOUR_INFURA_PROJECT_ID";
        const CONTRACT_ABI = [ /* WKLEJ TUTAJ PEŁNE ABI KONTRAKTU */ ];

        // Inicjalizacja Web3
        async function initWeb3() {
            if(window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.enable();
                    loadContract();
                    return true;
                } catch (error) {
                    console.error("User denied account access");
                    return false;
                }
            } else {
                console.log("Using Infura");
                web3 = new Web3(new Web3.providers.HttpProvider(`https://mainnet.infura.io/v3/${INFURA_ID}`));
                loadContract();
                return true;
            }
        }

        function loadContract() {
            contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            updateUI();
        }

        // Portfel
        async function connectWallet() {
            if(!window.ethereum) {
                document.getElementById('walletStatus').innerHTML = "⚠️ Instaluj MetaMask!";
                return;
            }
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                document.getElementById('walletStatus').innerHTML = `✅ Podłączono: ${account.substring(0,6)}...${account.substring(38)}`;
                updateUI();
            } catch (error) {
                document.getElementById('walletStatus').innerHTML = "❌ Błąd łączenia";
            }
        }

        // Zakup tokenów
        async function buyTokens() {
            const amount = document.getElementById('buyAmount').value;
            const referrer = document.getElementById('referrer').value || account;
            
            if(!amount || amount <= 0) {
                document.getElementById('buyStatus').innerHTML = "⚠️ Wpisz kwotę ETH";
                return;
            }

            try {
                const weiAmount = web3.utils.toWei(amount, 'ether');
                await contract.methods.buyTokens().send({
                    from: account,
                    value: weiAmount
                });
                document.getElementById('buyStatus').innerHTML = "✅ Zakup udany!";
                updateSaleInfo();
            } catch (error) {
                document.getElementById('buyStatus').innerHTML = `❌ Błąd: ${error.message}`;
            }
        }

        // Staking
        async function stake() {
            const amount = document.getElementById('stakeAmount').value;
            if(!amount || amount <= 0) return;

            try {
                const weiAmount = web3.utils.toWei(amount, 'ether');
                await contract.methods.stakeTokens(weiAmount).send({ from: account });
                updateStakingInfo();
            } catch (error) {
                console.error(error);
            }
        }

        async function unstake() {
            try {
                await contract.methods.unstakeTokens().send({ from: account });
                updateStakingInfo();
            } catch (error) {
                console.error(error);
            }
        }

        // Aktualizacja UI
        async function updateStakingInfo() {
            const staked = await contract.methods.stakedBalances(account).call();
            document.getElementById('stakedTokens').innerText = web3.utils.fromWei(staked, 'ether') + " DFEPE";
        }

        async function updateSaleInfo() {
            try {
                const tokensSold = await contract.methods.tokensSold().call();
                const totalSupply = await contract.methods.PRESALE_SUPPLY().call();
                const percent = (tokensSold / totalSupply * 100).toFixed(2);
                document.getElementById('progress').style.width = percent + '%';
                document.getElementById('tokensSold').innerText = percent + '%';

                const price = await contract.methods.getTokensPerETH().call();
                document.getElementById('currentPrice').innerText = web3.utils.fromWei(price, 'ether') + " DFEPE/ETH";
            } catch (error) {
                console.error(error);
            }
        }

        // Automatyczne odświeżanie
        window.addEventListener('load', async () => {
            const connected = await initWeb3();
            if(connected) {
                setInterval(updateSaleInfo, 10000);
                setInterval(updateStakingInfo, 10000);
            }
        });
    </script>
</body>
</html>
